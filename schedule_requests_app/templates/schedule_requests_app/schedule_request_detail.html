{% extends "main_app/base.html" %}
{% load static %}

{% block title %}日程調整のお願い{% endblock %}
{% block page_title_in_header %}日程調整のお願い{% endblock %}

{% block content %}
<main class="flex-1 p-6 @container/main">
    <div class="max-w-2xl mx-auto">
        <header class="mb-6 text-center">
            <h1 class="text-slate-900 text-3xl font-bold leading-tight">日程調整のお願い</h1>
            {% if user == schedule_request.invitee %}
                <p class="text-slate-500 mt-1">「{{ schedule_request.requester.username }}」さんから申請が届いています。</p>
            {% else %}
                 <p class="text-slate-500 mt-1">あなたが「{{ schedule_request.invitee.username }}」さんに送った申請です。</p>
            {% endif %}
        </header>
        <div class="bg-white shadow-lg rounded-2xl overflow-hidden">
            <div class="p-6 sm:p-8">
                <div class="flex flex-col @md:flex-row items-center @md:justify-between gap-6 mb-6 pb-6 border-b border-slate-200">
                    <div class="flex items-center gap-3">
                        <div class="size-12 rounded-full bg-slate-200 text-slate-500 flex items-center justify-center font-bold text-xl">{{ schedule_request.requester.username.0|upper }}</div>
                        <div>
                            <p class="text-sm text-slate-500">申請者</p>
                            <p class="text-slate-800 font-semibold">{{ schedule_request.requester.username }}</p>
                        </div>
                    </div>
                    <span class="material-symbols-outlined text-slate-400 text-3xl transform @md:rotate-0 rotate-90">arrow_forward</span>
                    <div class="flex items-center gap-3">
                        <div class="size-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-xl">{{ schedule_request.invitee.username.0|upper }}</div>
                        <div>
                            <p class="text-sm text-slate-500">被申請者</p>
                            <p class="text-slate-800 font-semibold">{{ schedule_request.invitee.username }}</p>
                        </div>
                    </div>
                    <div class="ml-auto @md:ml-0">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold 
                            {% if schedule_request.status == 'pending' %}bg-yellow-100 text-yellow-800{% endif %}
                            {% if schedule_request.status == 'accepted' %}bg-green-100 text-green-800{% endif %}
                            {% if schedule_request.status == 'declined' %}bg-red-100 text-red-800{% endif %}
                            {% if schedule_request.status == 'canceled' %}bg-gray-100 text-gray-800{% endif %}
                        ">
                            <span class="material-symbols-outlined text-sm mr-1.5">
                                {% if schedule_request.status == 'pending' %}hourglass_empty{% endif %}
                                {% if schedule_request.status == 'accepted' %}check_circle{% endif %}
                                {% if schedule_request.status == 'declined' %}cancel{% endif %}
                                {% if schedule_request.status == 'canceled' %}do_not_disturb_on{% endif %}
                            </span>
                            {{ schedule_request.get_status_display }}
                        </span>
                    </div>
                </div>

                {# --- ✨✨ ここが修正ポイント！ ✨✨ --- #}
                <h2 class="text-slate-800 text-2xl font-semibold mb-1">{{ display_title }}</h2>
                {# --- ✨✨ 修正ここまで！ ✨✨ --- #}

                {% if schedule_request.proposed_description %}
                <p class="text-slate-500 text-sm mb-6">AIアシスタントからのメッセージ: "{{ schedule_request.proposed_description }}"</p>
                {% endif %}

                <div class="grid grid-cols-1 @sm:grid-cols-2 gap-x-6 gap-y-5">
                    <div>
                        <label class="block text-xs text-slate-500 mb-1">提案された開始日時</label>
                        <div class="flex items-center gap-2 text-slate-700">
                            <span class="material-symbols-outlined text-base">event</span>
                            <p class="text-sm font-medium">{{ schedule_request.proposed_start_datetime|date:"Y/n/j H:i" }}</p>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-500 mb-1">提案された終了日時</label>
                        <div class="flex items-center gap-2 text-slate-700">
                            <span class="material-symbols-outlined text-base">event_busy</span>
                            <p class="text-sm font-medium">{{ schedule_request.proposed_end_datetime|date:"Y/n/j H:i" }}</p>
                        </div>
                    </div>
                    {% if schedule_request.proposed_location %}
                    <div class="@sm:col-span-2">
                        <label class="block text-xs text-slate-500 mb-1">提案された場所</label>
                        <div class="flex items-center gap-2 text-slate-700">
                            <span class="material-symbols-outlined text-base">location_on</span>
                            <p class="text-sm font-medium">{{ schedule_request.proposed_location }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            {% if user_is_invitee_and_pending %}
            <div class="bg-slate-50 px-6 sm:px-8 py-5 border-t border-slate-200">
                <div class="flex flex-col @xs:flex-row justify-end gap-3">
                    <form action="{% url 'schedule_requests_app:respond_schedule_request' schedule_request.id 'decline' %}" method="post" class="flex-grow @xs:flex-grow-0">
                        {% csrf_token %}
                        <button type="submit" class="w-full flex items-center justify-center gap-2 min-w-[120px] h-11 px-4 bg-slate-200 hover:bg-slate-300 text-slate-700 text-sm font-medium rounded-lg transition-colors">
                            <span class="material-symbols-outlined text-base">close</span>
                            <span class="truncate">拒否する</span>
                        </button>
                    </form>
                    <form action="{% url 'schedule_requests_app:respond_schedule_request' schedule_request.id 'accept' %}" method="post" class="flex-grow @xs:flex-grow-0">
                        {% csrf_token %}
                        <button type="submit" class="w-full flex items-center justify-center gap-2 min-w-[120px] h-11 px-4 bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium rounded-lg transition-colors shadow-md">
                            <span class="material-symbols-outlined text-base">check</span>
                            <span class="truncate">承認して予定に追加</span>
                        </button>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</main>
{% endblock %}